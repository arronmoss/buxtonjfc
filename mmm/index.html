<!doctype html><html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-PMJ3GGG');</script>
    <!-- End Google Tag Manager -->

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://code.jquery.com/jquery-latest.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,600" rel="stylesheet">
<link href="styles.css" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript">
	google.charts.load("current", {packages:["timeline"]});
	google.charts.setOnLoadCallback(drawChart);
	function drawChart() {

        const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        //https://script.google.com/macros/s/AKfycbx4uriTLlVllJfZG0TMXTww1T90JqQJyV1D2C7QbvoMWT29KJk/exec
        // This is the MMM endpoint
		//var testUrl = "https://script.google.com/macros/s/AKfycbx4uriTLlVllJfZG0TMXTww1T90JqQJyV1D2C7QbvoMWT29KJk/exec?mode=test";
		var liveUrl = "https://script.google.com/macros/s/AKfycbx4uriTLlVllJfZG0TMXTww1T90JqQJyV1D2C7QbvoMWT29KJk/exec?team=Table-Mini-A";
		var container = document.getElementById('timeline');
		var chart = new google.visualization.Timeline(container);
		var dataTable = new google.visualization.DataTable();
		dataTable.addColumn({ type: 'string', id: 'Team' });
		dataTable.addColumn({ type: 'string', id: 'Version' });
		dataTable.addColumn({'type': 'string', 'role': 'tooltip', 'p': {'html': true}});
		dataTable.addColumn({ type: 'date', id: 'Start' });
		dataTable.addColumn({ type: 'date', id: 'End' });
		var pish = new Array();
		var websites = new Array();
		var deployments = new Array();

		$.getJSON( liveUrl , function( data ) {
			console.log(data);
			var items = [];
			var hourcounter = 1;
			$.each( data, function( key, val ) {

				if (val[0] == '') {
					return false;
				}
				var start = new Date(val[2]);

				if(start.toString()==='Invalid Date') {
                    console.log(val[1] + ' ' +start.toString()); // shows 'Invalid Date'
                    console.log(val[1] + ' ' +typeof start); // shows 'object'
                    console.log(val[1] + ' ' +start instanceof Date); // shows 'true'
                }

				var webAddress = val[0].replace("https://", "");
				var webAddress = webAddress.replace("/", "");
				var platform = val[3];
				var devops = '';
				var tomorrow = new Date(val[2]);
				tomorrow.setDate(tomorrow.getDate() + 1);
				if (val[1] && val[2]) {

					// val[5] > 3 means we dont register sites till they have 3 deploys in 3 months
                    if (start > monthAdd(new Date(), -2) && val[5]>3) {
						if(websites.indexOf(webAddress)=== -1) {
							websites.push(webAddress);
							deployments.push(1);
						} else {
							deployments[websites.indexOf(webAddress)]++;
						}

						pish.push([
							webAddress,
							val[1],
                            createCustomHTMLContent(webAddress, start.getDate()+' '+ monthNames[start.getMonth()]+' '+start.getFullYear(), val[1], platform, devops),
							new Date(start.getFullYear(), start.getMonth(), start.getDate(), 0, hourcounter, 0, 0),
							new Date(start.getFullYear(), start.getMonth(), start.getDate(), 0, hourcounter+1, 0, 0)
						]);
						hourcounter++;
					}
				}
			});
			console.log(pish);
			dataTable.addRows(pish);

			var options = {
				tooltip: {isHtml: true},
				timeline: { groupByRowLabel: true },
				width: 1500
			};

			//console.log(dataTable);
			chart.draw(dataTable, options);
			afterDraw();
			$("#showing").text(websites.length +' sites');

/*			var list = [];
			for (var j = 0; j < websites.length; j++)
				list.push({'deployment': deployments[j], 'website': websites[j]});
				list.sort(function(a, b) {
				return ((a.deployment < b.deployment) ? -1 : ((a.deployment == b.deployment) ? 0 : 1));
			});
			for (var k = 0; k < list.length; k++) {
				websites[k] = list[k].website;
				deployments[k] = list[k].deployment;
			}
*/
			//console.log(deployments);
			//var halloffame = websites.slice(Math.max(websites.length - 5, 1));
			var halloffame = websites.slice(0, 5);


			var hflist = $('#hallofhame')
			$.each(halloffame, function(i) {
				var hfli = $('<li/>')
						.addClass('ui-menu-item')
						.attr('role', 'menuitem')
						.appendTo(hflist);
				var a = $('<a/>')
						.addClass('ui-all')
						.text( this )
						.appendTo(hfli);
			});



			var cList = $('#website_urls')
			$.each(websites, function(i) {
				var li = $('<li/>')
						.addClass('ui-menu-item')
						.attr('role', 'menuitem')
						.appendTo(cList);
				var a = $('<a/>')
						.addClass('ui-all')
						.text( this )
						.appendTo(li);
			});
		});
	}

    function afterDraw() {
        var g = document.getElementsByTagName("svg")[0].getElementsByTagName("g")[0];
        document.getElementsByTagName("svg")[1].parentNode.style.top = '50px';
        document.getElementsByTagName("svg")[1].style.overflow = 'visible';

        //document.getElementsByTagName("svg")[1].style.background = 'blue';

        var height = 480;
        g.setAttribute('transform','translate(0,-'+height+')');
        g.setAttribute('style','overflow:visible');
        g = null;
    }

    function createCustomHTMLContent(website, date, version, platform, devops) {
        return '<div class="z1m2pop">' +
            '<div class="wrap"><span class="popimg"><img src="icons/b-site-01.svg" /></span><p class="head">' + website + '</p></div>' +
            '<div class="wrap"><span class="popimg"><img src="icons/b-calendar-01.svg" /></span><p>Date: ' + date+ '</p></div>' +
            '<div class="wrap"><span class="popimg"><img src="icons/b-git-01.svg" /></span><p>Ref: ' + version+ '</p></div>' +
            '<div class="wrap"><span class="popimg"><img src="icons/b-magento-01.svg" /></span><p>Platform: ' + platform + '</p></div>' +
           /* '<div class="wrap"><span class="popimg"><img src="icons/b-devops-01.svg" /></span><p>DevOps: ' + devops + '</p></div>' + */
            '</div>';
    }

	function monthAdd(date, month) {
		var temp = date;
		temp = new Date(date.getFullYear(), date.getMonth(), 1);
		temp.setMonth(temp.getMonth() + (month + 1));
		temp.setDate(temp.getDate() - 1);

		if (date.getDate() < temp.getDate()) {
			temp.setDate(date.getDate());
		}
		return temp;
	}

    function disabledAction () {
        // alert("Sorry this function is not yet available. If you wish to provide feedback please Submit your site and provide more information.");
        // return false;
        $('#overlay').show();
        $('#pop').show();
    }






    function getDateFromIso(string) {

        console.log('string');
        console.log(string);

        try{
            var aDate = new Date();
            var regexp = "([0-9]{4})(-([0-9]{2})(-([0-9]{2})" +
                "(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\.([0-9]+))?)?" +
                "(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";
            var d = string.match(new RegExp(regexp));

            var offset = 0;
            var date = new Date(d[1], 0, 1);


            console.log('date');
            console.log(date);

return;

            if (d[3]) { date.setMonth(d[3] - 1); }
            if (d[5]) { date.setDate(d[5]); }

            //if (d[7]=='23') { date.setDate(d[5]+1); }
            //msgBox("test", Browser.Buttons.OK_CANCEL);
            //return date;

            if (d[7]) { date.setHours(d[7]); }
            if (d[8]) { date.setMinutes(d[8]); }
            if (d[10]) { date.setSeconds(d[10]); }
            if (d[12]) { date.setMilliseconds(Number("0." + d[12]) * 1000); }
            if (d[14]) {
                offset = (Number(d[16]) * 60) + Number(d[17]);
                offset *= ((d[15] == '-') ? 1 : -1);
            }

            offset -= date.getTimezoneOffset();
            time = (Number(date) + (offset * 60 * 1000));
            return aDate.setTime(Number(time));
        } catch(e){
            return;
        }
    }







</script>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PMJ3GGG"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="wrapper">

    <div class="header">
        <div class="tophead">
            <div class="logo">
                <img src="logo-01.svg" alt="M2 Deployments" />
            </div>
			<span class="mobile">MMM diddly</span>
            <div class="submit">
                <a href="mailto:submit@m2deployments.info?Subject=Submission"><span class="icon"><img src="icons/site-01.svg" alt="Submit a site" /></span><span class="link">Submit a site</span></a>
            </div>
            <div class="filter-trigger">
                <a onclick="return disabledAction();"><p>Filtering By</p><span class="icon"><img src="icons/filter_on-01.svg" alt="Submit a site" /></span></a>
            </div>
        </div>
        <div class="filters">
            <div class="over"></div>
            <div>
                <a onclick="return disabledAction();">
                    <span>Version</span>
                    <span class="val">2.3</span>
                </a>
            </div>
            <div>
                <a onclick="return disabledAction();">
                    <span>Platform</span>
                    <span class="val">Open Source</span>
                </a>
            </div>
            <div>
                <a onclick="return disabledAction();">
                    <span>Hosting</span>
                    <span class="val">UK Fast</span>
                </a>
            </div>
            <div>
                <a onclick="return disabledAction();">
                    <span>Dev Ops</span>
                    <span class="val">MDOQ</span>
                </a>
            </div>
        </div>
    </div>

    <div id="timeline-wrap">
        <ul id="website_urls" style="display: none;"></ul>
        <div id="timeline" style="height: 550px;"></div>
    </div>
    <div class="footer tophead">
        <div class="submit" style="width:20%">
            <a href="mailto:submit@m2deployments.info?Subject=Site Submission&Content=Please Enter your M2 Site URL"><span class="icon"><img src="icons/site-01.svg" alt="Submit a site" /></span><span class="link">Submit a site</span></a>
        </div>

        <div id="skip">


        </div>

        <div class="submit showing" style="width:20%">
        </div>
    </div>

</div>

<div id="overlay" style="display: none;"></div>
<div id="pop" style="display: none;">
    <p>Sorry this function is not yet available. If you wish to provide feedback, please submit your site and provide more information.</p>
    <a class="action submitsite" href="mailto:submit@m2deployments.info?Subject=Site Submission&Content=Please Enter your M2 Site URL">Submit my site</a>
</div>

<script>
    $(document).ready(function(){
        $('#overlay').click(function(){
            $(this).hide();
            $('#pop').hide();
        });

        $('.submitsite').click(function(){
            $('#overlay').hide();
            $('#pop').hide();
        });

    });
</script>
</body>
</html>
